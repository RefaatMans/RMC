<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RMC — Create Appointment</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css"
    />

    <style>
      :root {
        --bg: #eaf4ff;
        --card: #fff;
        --primary: #1f6fff;
        --primary-600: #1859cc;
        --accent: #22c1ee;
        --text: #0f172a;
        --muted: #475569;
        --ring: rgba(31, 111, 255, 0.35);
        --shadow: 0 10px 30px rgba(2, 32, 71, 0.08);
        --radius-xl: 20px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(160deg, #dceeff 0%, #f6f9fc 100%);
        color: var(--text);
        line-height: 1.5;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px clamp(16px, 4vw, 48px);
        background: linear-gradient(90deg, #1f6fff, #22c1ee);
        color: #fff;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 800;
      }
      .name {
        font-size: clamp(1.1rem, 2.2vw, 1.4rem);
      }
      .back {
        color: #fff;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .wrap {
        margin: 0 2%;
      }
      .hero {
        margin: 16px 0 24px;
        text-align: center;
      }
      .hero h1 {
        margin: 0;
        font-weight: 900;
        color: var(--primary-600);
        font-size: clamp(1.6rem, 3.5vw, 2.2rem);
      }
      .hero p {
        margin: 6px 0 0;
        color: var(--muted);
      }

      .two-col {
        display: grid;
        gap: 16px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 980px) {
        .two-col {
          grid-template-columns: 0.8fr 1.2fr;
        }
      }

      .card {
        background: var(--card);
        border-radius: var(--radius-xl);
        padding: 22px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(15, 23, 42, 0.06);
      }

      form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 640px) {
        form {
          grid-template-columns: 1fr 1fr;
        }
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .field.full {
        grid-column: 1 / -1;
      }
      label {
        font-weight: 700;
        color: #0b2447;
      }

      input,
      select {
        appearance: none;
        -webkit-appearance: none;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: linear-gradient(180deg, #fff, #f0f7ff);
        outline: none;
        font-size: 1rem;
        color: var(--text);
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      input:focus,
      select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--ring);
      }

      .actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 16px;
      }
      .btn {
        border: 0;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 10px 24px rgba(2, 32, 71, 0.1);
        transition: transform 0.1s, box-shadow 0.2s;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn-primary {
        color: #fff;
        background: linear-gradient(135deg, var(--accent), var(--primary));
      }
      .btn-secondary {
        background: #eef4ff;
        color: var(--primary-600);
        border: 1px solid rgba(31, 111, 255, 0.25);
      }

      .sched-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }
      .sched-title {
        font-weight: 900;
        color: #0b2447;
      }
      .muted {
        color: var(--muted);
        font-size: 0.95rem;
      }
      .table-wrap {
        max-height: 480px;
        overflow: auto;
        border: 1px solid rgba(15, 23, 42, 0.06);
        border-radius: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        font-size: 0.5rem;
      }
      thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #f0f7ff;
        color: #0b2447;
        text-align: left;
        font-weight: 800;
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
        padding: 10px 12px;
      }
      tbody td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      }
      tbody tr:hover {
        background: #f8fbff;
      }
      .empty-row td {
        text-align: center;
        color: var(--muted);
      }

      .th-comment {
        width: 34%;
      }
      .comment-cell {
        min-width: 320px;
      }
      .comment-input {
        display: block;
        width: 80%;
        max-width: 100%;
        min-height: 38px;
        line-height: 1.35;
        padding: 10px 12px;
        font-size: 1rem;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: linear-gradient(180deg, #fff, #f7fbff);
        outline: none;
        resize: vertical;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .comment-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--ring);
      }

      /* Compact schedule */
      .schedule-compact .sched-head {
        margin-bottom: 6px;
      }
      .schedule-compact .sched-title {
        font-size: 0.95rem;
      }
      .schedule-compact .muted {
        font-size: 0.82rem;
      }
      .schedule-compact .table-wrap {
        max-height: 72vh;
      }
      .schedule-compact table {
        font-size: 0.85rem;
        line-height: 1.2;
      }
      .schedule-compact thead th {
        padding: 6px 8px;
        font-size: 0.85rem;
      }
      .schedule-compact tbody td {
        padding: 6px 8px;
      }
      .schedule-compact thead th:first-child,
      .schedule-compact tbody td:first-child {
        white-space: nowrap;
        width: 88px;
      }
      .schedule-compact .th-comment {
        width: 26%;
      }
      .schedule-compact .comment-cell {
        min-width: 220px;
      }
      .schedule-compact .comment-input {
        width: 72%;
        min-height: 26px;
        padding: 6px 8px;
        font-size: 0.85rem;
        border-radius: 8px;
      }

      /* NEW: small time input in table */
      .time-input {
        width: 88px;
        padding: 4px 6px;
        border-radius: 8px;
        border: 1px solid rgba(15, 23, 42, 0.15);
        background: #fff;
        font: inherit;
      }
      .time-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--ring);
      }
    </style>
  </head>
  <body>
    <header class="header" role="banner">
      <div class="brand" aria-label="RMC Medical Center">
        <img src="./assets/LogoCircle.png" alt="Logo" style="width: 8%" />
        <span class="name">Ruwais Medical Center</span>
      </div>
      <a class="back" href="home.html" aria-label="Back to dashboard">
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Back
      </a>
    </header>

    <main class="wrap" role="main">
      <section class="hero">
        <h1>Create Appointment</h1>
        <p>
          Pick a doctor, a patient, and the date &amp; time. The right side
          shows that doctor’s schedule for the selected day.
        </p>
      </section>

      <section class="two-col">
        <!-- Left: Form -->
        <section class="card" aria-label="Create appointment form">
          <form id="apptForm" novalidate>
            <div class="field full">
              <label for="doctor">Doctor *</label>
              <select id="doctor" name="doctor" required>
                <option value="" selected disabled>Loading doctors…</option>
              </select>
              <small class="muted" id="doctorHint"></small>
            </div>

            <div class="field full">
              <label for="patient">Patient *</label>
              <select id="patient" name="patient" required>
                <option value="" selected disabled>Loading patients…</option>
              </select>
              <small class="muted" id="patientHint"></small>
            </div>

            <div class="field full">
              <label for="startAt">Date &amp; Time *</label>
              <input
                id="startAt"
                name="startAt"
                type="datetime-local"
                required
              />
            </div>

            <div class="actions full">
              <button type="button" class="btn btn-secondary" id="cancelBtn">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save Appointment
              </button>
            </div>
          </form>
        </section>

        <!-- Right: Schedule (compact + editable time) -->
        <section class="card schedule-compact" aria-label="Doctor day schedule">
          <div class="sched-head">
            <div>
              <div class="sched-title">Doctor’s Schedule</div>
              <div class="muted">
                <span id="schedDoctorName">—</span> •
                <span id="schedDate">Select date</span>
              </div>
            </div>
            <div class="muted"><strong id="schedCount">0</strong> appt(s)</div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <!-- headers injected by JS -->
                </tr>
              </thead>
              <tbody id="scheduleBody">
                <tr class="empty-row">
                  <td>Pick a doctor and date to view schedule.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </section>
    </main>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <script type="module">
      if (sessionStorage.getItem("rmcAuth") !== "1")
        window.location.replace("index.html");

      /* ---------- Tom Select ---------- */
      let doctorTS, patientTS;
      const normalizePhone = (p) => (p || "").toString().replace(/\D/g, "");
      const fmtPhone = (p) => (p ?? "").toString().trim();

      function enhanceDoctorSelect() {
        if (!window.TomSelect) return;
        doctorTS?.destroy();
        doctorTS = new TomSelect("#doctor", {
          create: false,
          allowEmptyOption: true,
          searchField: ["text"],
          sortField: { field: "text", direction: "asc" },
          placeholder: "Select a doctor",
          maxOptions: 5000,
          plugins: ["clear_button"],
          onChange: () =>
            document
              .getElementById("doctor")
              .dispatchEvent(new Event("change")),
        });
      }
      function enhancePatientSelect() {
        if (!window.TomSelect) return;
        patientTS?.destroy();
        patientTS = new TomSelect("#patient", {
          create: false,
          allowEmptyOption: true,
          searchField: ["phonekey"],
          sortField: { field: "text", direction: "asc" },
          maxOptions: 5000,
          plugins: ["clear_button"],
          placeholder: "Search by mobile number",
          render: {
            option: (d, e) =>
              `<div>${e(d.text)}${
                d.phone
                  ? ` <small style="color:white">${e(d.phone)}</small>`
                  : ""
              }</div>`,
            item: (d, e) =>
              `<div>${e(d.text)}${
                d.phone
                  ? ` <small style="color:white">${e(d.phone)}</small>`
                  : ""
              }</div>`,
          },
        });
      }

      /* ---------- Firebase ---------- */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import {
        initializeFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        where,
        serverTimestamp,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCy2-qGCMMlNsSuKrqSVUBELsiwQXUN19w",
        authDomain: "rmc-db-486f0.firebaseapp.com",
        projectId: "rmc-db-486f0",
        storageBucket: "rmc-db-486f0.firebasestorage.app",
        messagingSenderId: "711840343507",
        appId: "1:711840343507:web:21bf0e1c9448072ce47b26",
      };
      const app = initializeApp(firebaseConfig);
      const db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false,
      });

      /* ---------- DOM ---------- */
      const form = document.getElementById("apptForm");
      const toast = document.getElementById("toast");
      const cancelBtn = document.getElementById("cancelBtn");
      const doctorSel = document.getElementById("doctor");
      const patientSel = document.getElementById("patient");
      const doctorHint = document.getElementById("doctorHint");
      const patientHint = document.getElementById("patientHint");
      const startAtEl = document.getElementById("startAt");

      const schedDoctorName = document.getElementById("schedDoctorName");
      const schedDate = document.getElementById("schedDate");
      const schedCount = document.getElementById("schedCount");
      const scheduleBody = document.getElementById("scheduleBody");
      const tableHeadRow = document.querySelector(".table-wrap thead tr");

      /* ---------- Helpers ---------- */
      const showToast = (m) => {
        toast.textContent = m;
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => toast.classList.remove("show"), 2200);
      };
      const byName = (a, b) =>
        (a.name || "").localeCompare(b.name || "", undefined, {
          sensitivity: "base",
        });
      const toJsDate = (v) =>
        v?.toDate ? v.toDate() : v instanceof Date ? v : new Date(v);
      const pad2 = (n) => String(n).padStart(2, "0");
      const fmtTime12 = (d) => {
        const h = d.getHours(),
          m = d.getMinutes();
        const mer = h >= 12 ? "PM" : "AM";
        const hour12 = h % 12 || 12;
        return `${hour12}:${pad2(m)} ${mer}`;
      };

      // NEW: time helpers for editing (keep same date)
      const timeHHMM = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      const localYMD = (d) =>
        `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
      const setTimeOnDate = (d, hhmm) => {
        const [h, m] = hhmm.split(":").map((n) => parseInt(n || "0", 10));
        return new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0);
      };
      const slotKeyFor = (doctorId, dtLocal) => `${doctorId}|${dtLocal}`;

      function autosize(el) {
        el.style.height = "auto";
        const max = 180;
        el.style.height = Math.min(max, el.scrollHeight) + "px";
      }

      /* ---------- Data ---------- */
      let patientsById = {};
      async function loadDoctors() {
        const s = await getDocs(collection(db, "doctors"));
        return s.docs.map((d) => ({ id: d.id, ...d.data() })).sort(byName);
      }
      async function loadPatients() {
        const s = await getDocs(collection(db, "patients"));
        return s.docs.map((d) => ({ id: d.id, ...d.data() })).sort(byName);
      }

      function fillDoctorSelect(sel, doctors) {
        sel.innerHTML = "";
        const ph = document.createElement("option");
        ph.value = "";
        ph.disabled = true;
        ph.selected = true;
        ph.textContent = doctors.length
          ? "Select a doctor"
          : "No doctors found";
        sel.appendChild(ph);
        for (const d of doctors) {
          const o = document.createElement("option");
          o.value = d.id;
          o.textContent = d.name || "(no name)";
          o.dataset.name = d.name || "";
          sel.appendChild(o);
        }
        sel.disabled = doctors.length === 0;
      }
      function fillPatientSelect(sel, patients) {
        sel.innerHTML = "";
        const ph = document.createElement("option");
        ph.value = "";
        ph.disabled = true;
        ph.selected = true;
        ph.textContent = patients.length ? " " : "No patients found";
        sel.appendChild(ph);
        for (const p of patients) {
          const phone = (p.phone ?? "").trim();
          const phoneKey = phone.replace(/\D/g, "");
          const o = document.createElement("option");
          o.value = p.id;
          o.textContent = `${p.name || "(no name)"}${
            phone ? " — " + phone : ""
          }`;
          o.dataset.name = p.name || "";
          o.dataset.phone = phone || "";
          o.dataset.phonekey = phoneKey || "";
          o.dataset.file = p.fileNumber ?? "";
          sel.appendChild(o);
        }
        sel.disabled = patients.length === 0;
      }

      /* ---------- Table rendering ---------- */
      function setTableHeaders(showDoctorCol) {
        tableHeadRow.innerHTML = showDoctorCol
          ? `<th style="width:88px">Time</th><th style="width:180px">Doctor</th><th>Patient</th><th style="width:96px">File #</th><th style="width:120px">Mobile</th><th class="th-comment">Comment</th>`
          : `<th style="width:88px">Time</th><th>Patient</th><th style="width:96px">File #</th><th style="width:120px">Mobile</th><th class="th-comment">Comment</th>`;
      }

      function attachCommentHandlers(inputEl, apptId) {
        autosize(inputEl);
        inputEl.addEventListener("input", (e) => {
          autosize(e.target);
          e.target.title = e.target.value || "";
          saveCommentDebounced(apptId, e.target.value);
        });
        inputEl.addEventListener("blur", (e) =>
          saveCommentImmediate(apptId, e.target.value)
        );
        inputEl.addEventListener("keydown", (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
            e.preventDefault();
            inputEl.blur();
          }
        });
      }

      // NEW: time save (only time on same day)
      async function saveTimeForAppointment(appt, newHHMM, inputEl) {
        if (!/^\d{2}:\d{2}$/.test(newHHMM)) {
          showToast("Invalid time");
          inputEl.value = timeHHMM(toJsDate(appt.startAt));
          return;
        }

        const oldDate = toJsDate(appt.startAt);
        const newDate = setTimeOnDate(oldDate, newHHMM); // same Y/M/D, new H:M
        const ymd = localYMD(oldDate); // date stays fixed
        const dtLocal = `${ymd}T${newHHMM}`;
        const newKey = slotKeyFor(appt.doctorId, dtLocal);

        try {
          // Conflict check (same doctor, same slot)
          const dup = await getDocs(
            query(
              collection(db, "appointments"),
              where("slotKey", "==", newKey)
            )
          );
          const conflict = dup.docs.some((d) => d.id !== appt.id);
          if (conflict) {
            showToast("This doctor already has an appointment at that time.");
            inputEl.value = timeHHMM(oldDate);
            return;
          }

          await updateDoc(doc(db, "appointments", appt.id), {
            startAt: newDate,
            slotKey: newKey,
            updatedAt: serverTimestamp(),
          });

          showToast("Time updated.");
          // Refresh list so ordering reflects new time
          refreshSchedule();
        } catch (err) {
          console.error(err);
          showToast("Failed to update time.");
          inputEl.value = timeHHMM(oldDate);
        }
      }

      function renderScheduleTable(appts, showDoctorCol) {
        scheduleBody.innerHTML = "";
        if (!appts.length) {
          const tr = document.createElement("tr");
          tr.className = "empty-row";
          tr.innerHTML = `<td colspan="${
            showDoctorCol ? 6 : 5
          }">No appointments for this day.</td>`;
          scheduleBody.appendChild(tr);
          return;
        }

        for (const a of appts) {
          const d = toJsDate(a.startAt);
          const time12 = fmtTime12(d);
          const time24 = timeHHMM(d);
          const p = patientsById[a.patientId] || {};
          const patientName = a.patientName || p.name || "(no name)";
          const fileNo = a.patientFileNumber ?? p.fileNumber ?? "—";
          const mobile = a.patientPhone ?? p.phone ?? "—";
          const doctorName = a.doctorName || "(unknown)";

          const tr = document.createElement("tr");
          tr.innerHTML = showDoctorCol
            ? `<td><input type="time" class="time-input" value="${time24}" step="300" title="${time12}"></td><td>${doctorName}</td><td>${patientName}</td><td>${fileNo}</td><td>${mobile}</td>
               <td class="comment-cell"><textarea class="comment-input" placeholder="Add note…" aria-label="Comment"></textarea></td>`
            : `<td><input type="time" class="time-input" value="${time24}" step="300" title="${time12}"></td><td>${patientName}</td><td>${fileNo}</td><td>${mobile}</td>
               <td class="comment-cell"><textarea class="comment-input" placeholder="Add note…" aria-label="Comment"></textarea></td>`;
          scheduleBody.appendChild(tr);

          // comment handlers
          const cInput = tr.querySelector(".comment-input");
          cInput.value = (a.comment ?? "").toString();
          cInput.title = cInput.value;
          attachCommentHandlers(cInput, a.id);

          // time handlers (only edit time)
          const tInput = tr.querySelector(".time-input");
          tInput.addEventListener("change", () =>
            saveTimeForAppointment(a, tInput.value, tInput)
          );
          tInput.addEventListener("blur", () =>
            saveTimeForAppointment(a, tInput.value, tInput)
          );
        }
      }

      /* ---------- Comment save (debounced) ---------- */
      const _commentTimers = new Map();
      function saveCommentDebounced(id, val) {
        clearTimeout(_commentTimers.get(id));
        const t = setTimeout(() => saveCommentImmediate(id, val), 400);
        _commentTimers.set(id, t);
      }
      async function saveCommentImmediate(id, val) {
        try {
          await updateDoc(doc(db, "appointments", id), {
            comment: (val || "").trim() || null,
            updatedAt: serverTimestamp(),
          });
        } catch (e) {
          console.error("Failed to save comment", e);
        }
      }

      /* ---------- Refresh schedule ---------- */
      async function refreshSchedule() {
        const doctorId = doctorSel.value;
        const doctorName =
          doctorSel.options[doctorSel.selectedIndex]?.dataset?.name ||
          doctorSel.options[doctorSel.selectedIndex]?.textContent ||
          "—";
        const dtLocal = startAtEl.value;

        if (!dtLocal) {
          setTableHeaders(!doctorId);
          schedDoctorName.textContent = doctorId ? doctorName : "—";
          schedDate.textContent = "Select date";
          scheduleBody.innerHTML = `<tr class="empty-row"><td colspan="${
            doctorId ? 5 : 6
          }">Pick a date to view schedule.</td></tr>`;
          schedCount.textContent = "0";
          return;
        }

        const d = new Date(dtLocal);
        const dayStart = new Date(
          d.getFullYear(),
          d.getMonth(),
          d.getDate(),
          0,
          0,
          0,
          0
        );
        const nextDay = new Date(
          d.getFullYear(),
          d.getMonth(),
          d.getDate() + 1,
          0,
          0,
          0,
          0
        );
        schedDate.textContent = dtLocal.split("T")[0];

        if (!doctorId) {
          setTableHeaders(true);
          schedDoctorName.textContent = "All doctors";
          try {
            const snap = await getDocs(
              query(
                collection(db, "appointments"),
                where("startAt", ">=", dayStart),
                where("startAt", "<", nextDay)
              )
            );
            const appts = snap.docs
              .map((d) => ({
                id: d.id,
                ...d.data(),
                startAtJs: toJsDate(d.data().startAt),
              }))
              .sort((a, b) => a.startAtJs - b.startAtJs);
            schedCount.textContent = appts.length;
            renderScheduleTable(appts, true);
          } catch (e) {
            console.error(e);
            scheduleBody.innerHTML = `<tr class="empty-row"><td colspan="6">Couldn't load schedule.</td></tr>`;
            schedCount.textContent = "0";
          }
          return;
        }

        setTableHeaders(false);
        schedDoctorName.textContent = doctorName;
        try {
          const snap = await getDocs(
            query(
              collection(db, "appointments"),
              where("doctorId", "==", doctorId)
            )
          );
          const appts = snap.docs
            .map((d) => ({
              id: d.id,
              ...d.data(),
              startAtJs: toJsDate(d.data().startAt),
            }))
            .filter(
              (a) =>
                a.startAtJs && a.startAtJs >= dayStart && a.startAtJs < nextDay
            )
            .sort((a, b) => a.startAtJs - b.startAtJs);
          schedCount.textContent = appts.length;
          renderScheduleTable(appts, false);
        } catch (e) {
          console.error(e);
          scheduleBody.innerHTML = `<tr class="empty-row"><td colspan="5">Couldn't load schedule.</td></tr>`;
          schedCount.textContent = "0";
        }
      }

      /* ---------- Init ---------- */
      (async () => {
        try {
          const [doctors, patients] = await Promise.all([
            loadDoctors(),
            loadPatients(),
          ]);
          fillDoctorSelect(doctorSel, doctors);
          fillPatientSelect(patientSel, patients);
          patientsById = Object.fromEntries(patients.map((p) => [p.id, p]));
          enhanceDoctorSelect();
          enhancePatientSelect();
          doctorHint.textContent = doctors.length
            ? `${doctors.length} doctor(s) available`
            : "Add doctors first.";
          patientHint.textContent = patients.length
            ? `${patients.length} patient(s) available`
            : "Add patients first.";
        } catch (e) {
          console.error(e);
          showToast("Error loading lists. Check console.");
        }
      })();

      /* ---------- Events ---------- */
      doctorSel.addEventListener("change", refreshSchedule);
      startAtEl.addEventListener("change", refreshSchedule);
      startAtEl.addEventListener("input", refreshSchedule);
      cancelBtn.addEventListener("click", () => {
        if (confirm("Discard changes?")) window.location.href = "home.html";
      });

      /* ---------- Save new appointment ---------- */
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const doctorId = doctorSel.value;
        const doctorName =
          doctorSel.options[doctorSel.selectedIndex]?.dataset?.name ||
          doctorSel.options[doctorSel.selectedIndex]?.textContent ||
          "";
        const patientId = patientSel.value;
        const patientName =
          patientSel.options[patientSel.selectedIndex]?.dataset?.name ||
          patientSel.options[patientSel.selectedIndex]?.textContent ||
          "";
        const dtLocal = startAtEl.value;

        if (!doctorId || !patientId || !dtLocal) {
          showToast("Please fill all required fields.");
          return;
        }

        try {
          const key = slotKeyFor(doctorId, dtLocal);
          const dup = await getDocs(
            query(collection(db, "appointments"), where("slotKey", "==", key))
          );
          if (!dup.empty) {
            showToast("This doctor already has an appointment at that time.");
            return;
          }

          const p = patientsById[patientId] || {};
          await addDoc(collection(db, "appointments"), {
            doctorId,
            doctorName,
            patientId,
            patientName,
            startAt: new Date(dtLocal),
            slotKey: key,
            createdAt: serverTimestamp(),
            patientFileNumber: p.fileNumber ?? null,
            patientPhone: p.phone ?? null,
            comment: null,
          });

          showToast("Appointment saved.");
          form.reset();
          doctorTS?.clear(true);
          patientTS?.clear(true);
          refreshSchedule();
        } catch (err) {
          console.error(err);
          showToast("Error saving appointment.");
        }
      });
    </script>
  </body>
</html>
