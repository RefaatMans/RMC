<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RMC — Cash In / Out</title>
  <style>
    :root{
      --bg:#eaf4ff; --card:#fff; --primary:#1f6fff; --primary-600:#1859cc;
      --accent:#22c1ee; --text:#0f172a; --muted:#475569; --ring:rgba(31,111,255,.35);
      --shadow:0 10px 30px rgba(2,32,71,.08); --radius-xl:20px;
      --green:#16a34a; --red:#dc2626;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(160deg, #dceeff 0%, #f6f9fc 100%); color:var(--text); line-height:1.5;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding:20px clamp(16px,4vw,48px); background: linear-gradient(90deg, #1f6fff, #22c1ee); color:#fff;
    }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800 }
    .brand svg{ width:36px; height:36px }
    .name{ font-size: clamp(1.1rem,2.2vw,1.4rem) }
    .back{ text-decoration:none; color:#fff; display:inline-flex; align-items:center; gap:6px }

    .wrap{ max-width:900px; margin:0 auto; padding: 0 clamp(16px,4vw,48px) 48px }
    .hero{ margin:16px 0 24px; text-align:center }
    .hero h1{ margin:0; font-weight:900; color:var(--primary-600); font-size: clamp(1.6rem,3.5vw,2.2rem) }
    .hero p{ margin:6px 0 0; color:var(--muted) }

    .card{ background:var(--card); border-radius: var(--radius-xl); padding:22px; box-shadow:var(--shadow); border:1px solid rgba(15,23,42,.06) }
    form{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .field{ display:flex; flex-direction:column; gap:8px }
    .full{ grid-column:1 / -1 }
    label{ font-weight:700; color:#0b2447 }
    input, select{
      appearance:none; -webkit-appearance:none;
      padding:12px 14px; border-radius:12px; border:1px solid rgba(15,23,42,.12);
      background: linear-gradient(180deg,#fff,#f0f7ff);
      outline:none; font-size:1rem; color:var(--text);
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus{ border-color:var(--primary); box-shadow:0 0 0 4px var(--ring) }

    .actions{ display:flex; gap:12px; justify-content:center; margin-top:8px }
    .btn{ border:0; padding:12px 16px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:0 10px 24px rgba(2,32,71,.1); transition:transform .1s, box-shadow .2s }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ color:#fff; background: linear-gradient(135deg, var(--accent), var(--primary)) }
    .btn-secondary{ background:#eef4ff; color:var(--primary-600); border:1px solid rgba(31,111,255,.25) }

    /* Segmented switch */
    .segmented{ display:inline-flex; background:#eef4ff; border:1px solid rgba(31,111,255,.25); border-radius:999px; padding:4px; gap:6px }
    .seg-btn{
      border:0; padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer; background:transparent; color:var(--primary-600);
      transition:background .2s, color .2s, box-shadow .2s;
    }
    .seg-btn.active.in{ background:rgba(22,163,74,.12); color:var(--green); box-shadow: inset 0 0 0 1px rgba(22,163,74,.35) }
    .seg-btn.active.out{ background:rgba(220,38,38,.12); color:var(--red); box-shadow: inset 0 0 0 1px rgba(220,38,38,.35) }
    .hint{ color:var(--muted); font-size:.95rem }

    .toast{
      position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
      background:#fff; border:1px solid rgba(31,111,255,.2); padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); display:none;
    }
    .toast.show{ display:block }

    @media (max-width: 640px){ form{ grid-template-columns:1fr } }

    /* Mode-aware theme swaps */
body.mode-in {
  --primary: #16a34a;         /* green */
  --primary-600: #15803d;
  --accent: #34d399;
  --ring: rgba(22,163,74,.35);
}
body.mode-out {
  --primary: #dc2626;         /* red */
  --primary-600: #b91c1c;
  --accent: #f87171;
  --ring: rgba(220,38,38,.35);
}

/* Tint the form card and border so mode is obvious */
body.mode-in .card {
  border-color: rgba(22,163,74,.35);
  background: linear-gradient(180deg, #ffffff, #f6fff7);
}
body.mode-out .card {
  border-color: rgba(220,38,38,.35);
  background: linear-gradient(180deg, #ffffff, #fff6f6);
}

/* Mode badge chip */
.mode-badge {
  font-weight: 900;
  padding: 8px 12px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.mode-badge.in {
  background: rgba(22,163,74,.12);
  color: #16a34a;
  border: 1px solid rgba(22,163,74,.25);
}
.mode-badge.out {
  background: rgba(220,38,38,.12);
  color: #dc2626;
  border: 1px solid rgba(220,38,38,.25);
}

  </style>

  <!-- Tom Select (searchable selects) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css">
</head>
<body>
  <header class="header" role="banner">
    <div class="brand" aria-label="RMC Medical Center">
      <img src="./assets/LogoCircle.png" alt="Logo" style="width: 8%" /><span
          class="name"
          >Ruwais Medical Center</span
        >
    </div>
    <a class="back" href="cashhome.html" aria-label="Back to dashboard">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg>
      Back
    </a>
  </header>

  <main class="wrap" role="main">
    <section class="hero">
      <h1>Cash In / Out</h1>
      <p class="hint">Record a payment or an expense. Use the switch to choose cash <strong>In</strong> or <strong>Out</strong>.</p>
    </section>

    <section class="card" aria-label="Cash in/out form">
      <div class="field full" style="align-items:center; gap:12px; flex-direction:row;">
        <div class="segmented" role="tablist" aria-label="Cash type">
          <button type="button" class="seg-btn active in" id="btnIn">Cash In</button>
          <button type="button" class="seg-btn out" id="btnOut">Cash Out</button>
        </div>
        <div class="mode-badge in" id="modeBadge">CASH IN</div>
        <span id="typeHint" class="hint">Patient & Doctor required.</span>
      </div>
<br>
      <form id="cashForm" novalidate>
        <div class="field">
          <label for="patient">Patient *</label>
          <select id="patient" name="patient" required>
            <option value="" selected disabled>Loading patients…</option>
          </select>
        </div>

        <div class="field">
          <label for="doctor">Doctor *</label>
          <select id="doctor" name="doctor" required>
            <option value="" selected disabled>Loading doctors…</option>
          </select>
        </div>

        <div class="field">
          <label for="amount">Amount *</label>
          <input id="amount" name="amount" type="number" min="0" step="0.01" placeholder="e.g., 25.00" required>
        </div>

        <div class="field">
          <label for="medicalAct">Medical Act</label>
          <input id="medicalAct" name="medicalAct" type="text" placeholder="e.g., Consultation, X-ray">
        </div>

        <div class="field">
          <label for="date">Date *</label>
          <input id="date" name="date" type="date" required>
        </div>

        <div class="field">
          <!-- spacer to keep grid balanced -->
        </div>

        <div class="actions full">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Entry</button>
        </div>
      </form>
    </section>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Tom Select script -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <!-- Firebase + page script -->
  <script type="module">
    if (sessionStorage.getItem('rmcAuth') !== '1') {
    window.location.replace('index.html');
  }
    // ---------- Searchable selects ----------
    let patientTS, doctorTS;
    function enhanceSelects() {
      if (!window.TomSelect) return;
      patientTS?.destroy();
      doctorTS?.destroy();

      patientTS = new TomSelect('#patient', {
        create:false, allowEmptyOption:true, searchField:['text'],
        sortField:{ field:'text', direction:'asc' }, maxOptions:5000, plugins:['clear_button']
      });
      doctorTS = new TomSelect('#doctor', {
        create:false, allowEmptyOption:true, searchField:['text'],
        sortField:{ field:'text', direction:'asc' }, maxOptions:5000, plugins:['clear_button']
      });
    }

    // ---------- Firebase ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      initializeFirestore,
      collection, addDoc, getDocs, query, where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCy2-qGCMMlNsSuKrqSVUBELsiwQXUN19w",
      authDomain: "rmc-db-486f0.firebaseapp.com",
      projectId: "rmc-db-486f0",
      storageBucket: "rmc-db-486f0.firebasestorage.app",
      messagingSenderId: "711840343507",
      appId: "1:711840343507:web:21bf0e1c9448072ce47b26",
    };

    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, { experimentalForceLongPolling:true, useFetchStreams:false });

    // ---------- DOM ----------
    const toast = document.getElementById('toast');
    const cashForm = document.getElementById('cashForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const patientSel = document.getElementById('patient');
    const doctorSel = document.getElementById('doctor');
    const amountEl  = document.getElementById('amount');
    const medicalActEl = document.getElementById('medicalAct');
    const dateEl = document.getElementById('date');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');
    const typeHint = document.getElementById('typeHint');

    let entryType = 'in'; // 'in' | 'out'

    // ---------- Helpers ----------
    const showToast = (msg) => {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), 2200);
    };
    const byName = (a,b)=> (a.name||"").localeCompare(b.name||"", undefined, {sensitivity:"base"});
    function fillSelect(selectEl, phText, items){
      selectEl.innerHTML = "";
      const ph = document.createElement('option');
      ph.value=""; ph.disabled=true; ph.selected=true; ph.textContent = phText;
      selectEl.appendChild(ph);
      for (const it of items){
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = it.name || '(no name)';
        opt.dataset.name = it.name || '';
        selectEl.appendChild(opt);
      }
      selectEl.disabled = items.length === 0;
    }
    const todayISO = ()=> {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };

    // ---------- Data loaders ----------
    async function loadPatients(){
      const snap = await getDocs(collection(db, 'patients'));
      return snap.docs.map(d=>({id:d.id, ...d.data()})).sort(byName);
    }
    async function loadDoctors(){
      const snap = await getDocs(collection(db, 'doctors'));
      return snap.docs.map(d=>({id:d.id, ...d.data()})).sort(byName);
    }

    // ---------- Type toggle ----------
    function setType(t){
  entryType = t; // 'in' | 'out'
  const body = document.body;
  const badge = document.getElementById('modeBadge');

  // Toggle body classes -> swaps theme vars & card/btn styles
  body.classList.remove('mode-in','mode-out');
  body.classList.add(t === 'in' ? 'mode-in' : 'mode-out');

  // Switch button states
  if (t === 'in'){
    btnIn.classList.add('active','in');
    btnOut.classList.remove('active','out');
    patientSel.required = true;
    doctorSel.required = true;
    typeHint.textContent = 'Patient & Doctor required.';
    if (badge){ badge.textContent = 'CASH IN'; badge.classList.remove('out'); badge.classList.add('in'); }
    amountEl.placeholder = 'e.g., +25.00';
  } else {
    btnOut.classList.add('active','out');
    btnIn.classList.remove('active','in');
    // For cash out, make them optional (you can flip to required if needed)
    patientSel.required = false;
    doctorSel.required = false;
    typeHint.textContent = 'Patient & Doctor optional.';
    if (badge){ badge.textContent = 'CASH OUT'; badge.classList.remove('in'); badge.classList.add('out'); }
    amountEl.placeholder = 'e.g., -25.00';
  }
}

    btnIn.addEventListener('click', ()=> setType('in'));
    btnOut.addEventListener('click', ()=> setType('out'));

    // ---------- Init ----------
    (async () => {
      try{
        const [patients, doctors] = await Promise.all([loadPatients(), loadDoctors()]);
        fillSelect(patientSel, patients.length ? 'Select a patient' : 'No patients found', patients);
        fillSelect(doctorSel, doctors.length ? 'Select a doctor' : 'No doctors found', doctors);
        enhanceSelects();
        dateEl.value = todayISO();
        setType('in');
      }catch(e){
        console.error(e);
        showToast('Failed to load lists.');
      }
    })();

    // ---------- Actions ----------
    cancelBtn.addEventListener('click', ()=>{
      if (confirm('Discard changes?')) window.location.href='cashhome.html';
    });

    cashForm.addEventListener('submit', async (e)=>{
      e.preventDefault();

      if (!cashForm.checkValidity()){
        cashForm.reportValidity();
        return;
      }

      const patientId = patientSel.value || null;
      const patientName = patientId
        ? (patientSel.options[patientSel.selectedIndex]?.dataset?.name || patientSel.options[patientSel.selectedIndex]?.textContent || '')
        : '';

      const doctorId = doctorSel.value || null;
      const doctorName = doctorId
        ? (doctorSel.options[doctorSel.selectedIndex]?.dataset?.name || doctorSel.options[doctorSel.selectedIndex]?.textContent || '')
        : '';

      const amount = parseFloat(amountEl.value);
      if (!(amount > 0)) { showToast('Amount must be greater than 0.'); return; }

      const medicalAct = medicalActEl.value.trim();
      const dateStr = dateEl.value; // YYYY-MM-DD
      if (!dateStr){ showToast('Please pick a date.'); return; }

      // For "in", enforce patient/doctor required in code too (in case browser didn't)
      if (entryType==='in' && (!patientId || !doctorId)){
        showToast('Patient and Doctor are required for Cash In.');
        return;
      }

      try{
        await addDoc(collection(db,'cash'), {
          type: entryType,                   // 'in' | 'out'
          amount,                            // positive
          signedAmount: entryType==='out' ? -amount : amount,
          medicalAct,
          date: new Date(dateStr),           // stored as Timestamp
          patientId, patientName,
          doctorId, doctorName,
          createdAt: serverTimestamp()
        });

        showToast('Entry saved.');
        cashForm.reset();
        // reset selects UI (Tom Select)
        patientTS?.clear(true);
        doctorTS?.clear(true);
        dateEl.value = todayISO();
        setType('in');
      }catch(err){
        console.error(err);
        showToast('Error saving entry.');
      }
    });
  </script>
</body>
</html>
